#{extends 'main.html' /}
#{set title:'Home' /}
<script type="application/javascript">
    var highlight = "highlight";
    $( document ).ready(function() {
        $('.audioTrack').click(function(){
            console.log("click@")
            $('.highlight').removeClass('highlight');
            $(this).addClass('highlight');
            playAudio(this.id);
        });

        $("#ownVibe").bind("ended", function(){
            nextAudio();
        });
        function playAudio(id){
            document.ownVibe = document.getElementById("ownVibe");
            document.ownVibe.idAudio = id;
            document.ownVibe.src = "/audio/" + id;
            document.ownVibe.play();

            $(".audioTrack").removeClass(highlight);
            $(event.target).addClass('highlight');
        }
        function nextAudio(){
            document.ownVibe.idAudio = $(document.getElementById(document.ownVibe.idAudio)).next()[0].id;
            document.ownVibe.src = "/audio/" + document.ownVibe.idAudio;

            $(".audioTrack").removeClass(highlight);
            $("#" + document.ownVibe.idAudio).addClass('highlight');
            document.ownVibe.play();
        }
    });
    function removeAudio(){
        var audioIdToRemove = event.target.parentElement.firstChild.id;
        var url = "/audio/remove/" + audioIdToRemove;
        var elemToDelete = event.target.parentElement;
        $.post(url).done(function( data ) {
                    if(data.status == "Deleted"){
                        elemToDelete.remove();
                    }
                });
    }
    function shuffle(){
        var ul = document.querySelector('ul');
        for (var i = ul.children.length; i >= 0; i--) {
            ul.appendChild(ul.children[Math.random() * i | 0]);
        }
    }

</script>

<div id="middleman">
    <audio controls preload id="ownVibe"></audio>
    <a href="#" class="button" onclick="shuffle()">Shuffle</a>
    <ul>
    #{list items:audios, as:'audio'}
        <li><div id="${audio.id}" class="audioTrack box2 truncate">#{if audio.title != null }${audio.artist} – ${audio.title}#{/if}#{else}${audio.name}#{/else}</div><div onclick="removeAudio();" class="box2 box1">×</div></li>
    #{/list}
    </ul>

    #{form @Application.upload(audio), enctype:'multipart/form-data', method:'POST'}
        <input type="file" name="audioFile">
        <input type="submit" value="Submit">
    #{/form}

    <a href="@{Application.logout()}">Logout</a>
</div>
